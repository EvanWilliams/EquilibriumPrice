<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
  	<meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Equilibrium Price</title>

    <style>
    	.container {
			margin: 20px;
			padding: 20px;
			background-color: #f7f7f7;
			border: solid 1px #d9d9d9;
			border-radius: 2px;
		}
		.graphControlWrapper{
			display: grid;
			grid-template-columns: 1fr 1fr;
			grid-row-gap: 5px;
			padding: 30px 0px;
		}
		.slider,.range{
			width:75vh;
		}
		.numbers{
			padding-left:3px;
			width:75vh;
			display:flex;
			justify-content: space-between;

		}
		.title{   
			 padding: 18px 0px;
		}
    	#result {color:#7A81FF;}

    	@media screen and (max-width: 700px) {
		  input {
		    display:block;
		  }
		}
		@media screen and (max-width: 800px) {
		.chartWrapper {
		    width:560px;height:280px;
		  }
		}
		@media screen and (max-width: 600px) {
		.chartWrapper {
		    width:360px;height:180px;
		  }
		.numbers,.slider,.range{
			width: 35vh;
		}
		}
    </style>

  </head>
  <body>
  	<div id="intro" class="container">
  	ABC Company Inc. has just invented the XYZ Widget. A revolutionary product that will change the lives of everyone that buys it. In this exercise, you will help ABC Company Inc choose the correct equillibrium price for the new product.
  	</div>
  	<div id="input" class="container">
	  	<form>
	  		<div class="section">
		        <div class="title">Price for XYZ Widget in $:</div>

				<div class="numbers">
					<span>$1</span><span>$2</span><span>$3</span><span>$4</span><span>$5</span><span>$6</span><span>$7</span><span>$8</span><span>$9</span><span>$10</span>
				  </div>
				<div class="slider">
					<span><!-- half --></span>
					<input id="price" class="range" type="range" name="price" step="1" max="10" min="1">
					<span><!-- half --></span>
				</div>
				<div id="result" class="container">

				</div>
	        </div>

			<div class="graphControlWrapper">
				Inital Demand (in Units)<input type="text" value=10000 id="initalDemand">
				Decrease in Demand per Dollar increase in price<input type="text" value=-1000 id="demandChange">
				Inital Supply (in Units)<input type="text" value=8000 id="initalSupply">
				Increase in Supply per Dollar increase in price<input type="text" value=0 id="supplyChange">
			</div>

			<div>Click Calculate to generate a graph for your desired values.
				<input id="calculate" type="button" value="Calculate">
			</div>



	        </div>
	    </form>
    </div>
	<div class="chartWrapper container">
		<canvas id="dataChart"></canvas>
	</div>

	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
   	<script language="javascript">

    	// Equilibrium Price Equations:
    	//   Qsupply = Msupply * price + Bsupply
		//   Qdemand = Mdemand * price + Bdemand

    	let Mdemand = -1000;
    	let Bdemand = 10000;
    	let Msupply = 0; // what if ABC can hire more people when price goes up? 
    	let Bsupply = 8000;
		let maxRevenue = 0;
    	let consumption;
    	let supply;
		let revenue;
    	let message = "";
		chartData = {
			"labels":[],
			"revenue":[],
			"supply":[],
			"demand":[],
			"messages":[]}
		let revenueObject = {};

		const priceOptions = document.getElementsByName("price");
		const ctx = document.getElementById('dataChart');
		//Create the chart using Chart.js
		const myChart = new Chart(ctx, {
				data: {
					datasets: [
						{
							type: 'bar',
							label: 'Revenue',
							data: chartData.revenue,
						},
						{
							type: 'line',
							label: 'Supply',
							data: chartData.supply,
						},
						{
							type: 'line',
							label: 'Demand',
							data: chartData.demand,
						}
				],
					labels:chartData.labels
				}
			});

    	document.getElementById("calculate").addEventListener("click", calculateOutput);
		document.getElementById("price").addEventListener("change", updateRange);
		document.getElementById("initalDemand").addEventListener("change", initalDemandChanged);
		document.getElementById("demandChange").addEventListener("change", demandChangeUpdated);
		document.getElementById("initalSupply").addEventListener("change", initalSupplyChanged);
		document.getElementById("supplyChange").addEventListener("change", supplyChangeUpdated);

		function updateRange (){
			emptyChartData();
			calculateMaxRevenue(maxRevenue,priceOptions);
			displayMessage();
		}
		function addData(chart,labels, newData) {
			chart.data.labels = labels;
			chart.data.datasets.forEach((dataset) => {
				if(dataset.label === 'Revenue'){
					dataset.data = newData.revenue;
				}
				else if(dataset.label === 'Supply'){
					dataset.data = newData.supply;
				}
				else if(dataset.label === 'Demand'){
					dataset.data = newData.demand;
				}
			});
			chart.update();
		}

		function removeData(chart) {
			chart.data.labels = [];
			chart.data.datasets.forEach((dataset) => {
				dataset.data = [];
			});
			chart.update();
		}
		function displayMessage(){
			price = priceOptions[0].value;
			consumption = revenueObject[price].consumption;
			supply = revenueObject[price].supply;
			revenue = revenueObject[price].revenue;

			if (revenue === maxRevenue) {
				message = "This is the equilibrium price"
			}
			else{
				message = chartData.messages[price-1];
			}

			document.getElementById("result").innerHTML = "XYZ Supply:"+supply+"/month<br>"+"Price per Widget: $"+price+" per unit<br>"+"XYZ Widgets sold:"+consumption+"/month<br>Revenue:"+revenue+"/month<br><br>"+message;
		}
		const calculateMaxRevenue = (maxRevenue,priceOptions) => {
				//Inner function that calculates the maxRevenue and saves all the other variables so there is no need to recalculate later.
					let minimum = parseInt(priceOptions[0].min);
					let maximum = parseInt(priceOptions[0].max);
					debugger;
					
					for (var i = minimum ; i <= maximum; i++) {
						let consumption = i * Mdemand + Bdemand;
						let supply = i * Msupply + Bsupply;
						message = "";
						chartData.demand.push(consumption);//placing this here to fire first before revenue calculation.
						if (consumption >= supply) {
							consumption = supply;
							message = "ABC Company cannot make enough XYZ Widgets";
						}
						if (consumption <= 0) {
							consumption = 0;
							message = "No one will buy XYZ Widgets at this price";
						}
						let revenue = consumption * i;
						if(revenue < 0){
							revenue = 0;
						}
						revenueObject[i] = {
							"consumption": consumption,
							"supply":supply,
							"revenue":revenue
						}
						//setting up charting data to show the equilibrium price on a chart
						chartData.messages.push(message);
						chartData.revenue.push(revenue);
						chartData.supply.push(supply);
						chartData.labels.push("Price per Widget: $"+i)

						//check to see if the price and supply calculation is the largest in the set.
						if(maxRevenue <= revenue){
							maxRevenue = revenue;
						}
				}
				return maxRevenue;
			}
		function calculateOutput() {
			maxRevenue = calculateMaxRevenue(maxRevenue,priceOptions);
			//chart reset to make sure that this fires on submit.
			resetChart();
			displayMessage();
		}


		function emptyChartData(){
			chartData.revenue = [];
			chartData.supply = [];
			chartData.demand = [];
			chartData.labels = [];
			chartData.messages = [];
		}

		function resetChart(){
			removeData(myChart);
			emptyChartData();
			calculateMaxRevenue(0,priceOptions);
			//update the data for the chart refresh.
			addData(myChart,chartData.labels,chartData);
		}
		function initalDemandChanged(event){
			Bdemand = parseInt(event.target.value);
			resetChart();
		}
		function demandChangeUpdated(event){
			Mdemand = parseInt(event.target.value);
			resetChart();
		}

		function initalSupplyChanged(event){
			Bsupply = parseInt(event.target.value);
			resetChart();
		}
		function supplyChangeUpdated(event){
			Msupply = parseInt(event.target.value);
			resetChart();
		}
		//this is to set inital state of the graph without clicks
		calculateOutput();

	
    </script>
  </body>
</html>