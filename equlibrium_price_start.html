<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
  	<meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Equilibrium Price</title>

    <style>
		.chartWrapper{width:800px;height:400px;}
    	.container {margin:20px;padding:20px;background-color:#76D6FF;}
		.graphControlWrapper{
			display: grid;
			grid-template-columns: 1fr 1fr;
			grid-row-gap: 5px;
			padding: 30px 0px;
		}
    	#result {color:#7A81FF;}

    	@media screen and (max-width: 700px) {
		  input {
		    display:block;
		  }
		}
		@media screen and (max-width: 800px) {
		.chartWrapper {
		    width:600px;height:300px;
		  }
		}
		@media screen and (max-width: 600px) {
		.chartWrapper {
		    width:400px;height:200px;
		  }
		}
    </style>

  </head>
  <body>
  	<div id="intro" class="container">
  	ABC Company Inc. has just invented the XYZ Widget. A revolutionary product that will change the lives of everyone that buys it. In this exercise, you will help ABC Company Inc choose the correct equillibrium price for the new product.
  	</div>
  	<div id="input" class="container">
	  	<form>
	  		<div class="section">
		        Price for XYZ Widget:
				<input type="range" name="price" step="1" max="10" min="1">
		        <!-- <input type="radio" name="price" value=1> $1
		        <input type="radio" name="price" value=2> $2
		        <input type="radio" name="price" value=3> $3
		        <input type="radio" name="price" value=4> $4
		        <input type="radio" name="price" value=5> $5
		        <input type="radio" name="price" value=6> $6
		        <input type="radio" name="price" value=7> $7
		        <input type="radio" name="price" value=8> $8
		        <input type="radio" name="price" value=9> $9
		        <input type="radio" name="price" value=10> $10 -->
	        </div>

			<div class="graphControlWrapper">
				Inital Demand (in Units)<input type="text" value=22000 id="initalDemand">
				Decrease in Demand per Dollar increase in price<input type="text" value=2000 id="demandChange">
				Inital Supply (in Units)<input type="text" value=2000 id="initalSupply">
				Increase in Supply per Dollar increase in price<input type="text" value=2000 id="supplyChange">
			</div>

			<div>Click Calculate to generate a graph for your desired values.
				<input id="calculate" type="button" value="Calculate">
			</div>



	        </div>
	    </form>
    </div>
	<div class="chartWrapper">
		<canvas id="dataChart"></canvas>
	</div>
	
    <div id="result" class="container">

   	</div>
	
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
   	<script language="javascript">

    	// Equilibrium Price Equations:
    	//   Qsupply = Msupply * price + Bsupply
		//   Qdemand = Mdemand * price + Bdemand

    	let Mdemand = -2000;
    	let Bdemand = 22000;
    	let Msupply = 2000; // what if ABC can hire more people when price goes up? 
    	let Bsupply = 2000;
    	let consumption;
    	let supply;
		let revenue;
    	let message;
		chartData = {
			"labels":[],
			"revenue":[],
			"supply":[],
			"demand":[]}

		const priceOptions = document.getElementsByName("price");
		const ctx = document.getElementById('dataChart');
		//Create the chart using Chart.js
		const myChart = new Chart(ctx, {
				data: {
					datasets: [
						{
							type: 'bar',
							label: 'Total Revenue',
							data: chartData.revenue,
						},
						{
							type: 'line',
							label: 'Total Supply',
							data: chartData.supply,
						},
						{
							type: 'line',
							label: 'Total Demand',
							data: chartData.demand,
						}
				],
					labels:chartData.labels
				}
			});

    	document.getElementById("calculate").addEventListener("click", calculateOutput);

		function addData(chart,labels, newData) {
			chart.data.labels = labels;
			chart.data.datasets.forEach((dataset) => {
				if(dataset.label === 'Total Revenue'){
					dataset.data = newData.revenue;
				}
				else if(dataset.label === 'Total Supply'){
					dataset.data = newData.supply;
				}
				else if(dataset.label === 'Total Demand'){
					dataset.data = newData.demand;
				}
			});
			chart.update();
		}

		function removeData(chart) {
			chart.data.labels = [];
			chart.data.datasets.forEach((dataset) => {
				dataset.data = [];
			});
			chart.update();
		}

		function calculateOutput() {
			let price;
			let maxRevenue = 0;
			let revenueObject = {};
			message = "";

			const calculateMaxRevenue = (maxRevenue,priceOptions) => {
				//Inner function that calculates the maxRevenue and saves all the other variables so there is no need to recalculate later.
					let minimum = parseInt(priceOptions[0].min);
					let maximum = parseInt(priceOptions[0].max);
					for (var i = minimum ; i < maximum; i++) {
						let consumption = i * Mdemand + Bdemand;
						let supply = i * Msupply + Bsupply;
						let revenue = consumption * i;
						if(revenue < 0){
							revenue = 0;
						}
						revenueObject[i] = {
							"consumption": consumption,
							"supply":supply,
							"revenue":revenue
						}
						//setting up charting data to show the equilibrium price on a chart
						chartData.revenue.push(revenue);
						chartData.supply.push(supply);
						chartData.demand.push(consumption);
						chartData.labels.push("Price per Widget: $"+priceOptions[0].value)

						//check to see if the price and supply calculation is the largest in the set.
						if(maxRevenue <= revenue){
							maxRevenue = revenue;
						}
				}
				return maxRevenue;
			}

			maxRevenue = calculateMaxRevenue(maxRevenue,priceOptions);
			//chart reset to make sure that this fires on submit.
			resetChart();
			price = priceOptions[0].value;

			consumption = revenueObject[price].consumption;
			supply = revenueObject[price].supply;
			revenue = revenueObject[price].revenue;

			if (consumption > supply) {
				consumption = supply;
				message = "ABC Company cannot make enough XYZ Widgets";
			}

			if (consumption <= 0) {
				consumption = 0;
				message = "No one will buy XYZ Widgets at this price";
			}

			
			if (revenue === maxRevenue) {
				message = "This is the equilibrium price"
			}

			document.getElementById("result").innerHTML = "XYZ Supply:"+supply+"/month<br>"+"Price per Widget: $"+price+" per unit<br>"+"XYZ Widgets sold:"+consumption+"/month<br>Revenue:"+revenue+"/month<br><br>"+message;
			
		document.getElementById("initalDemand").addEventListener("change", initalDemandChanged);

		function emptyChartData(){
			chartData.revenue = [];
			chartData.supply = [];
			chartData.demand = [];
			chartData.labels = [];
		}

		function resetChart(){
			removeData(myChart);
			emptyChartData();
			calculateMaxRevenue(0,priceOptions);
			//update the data for the chart refresh.
			addData(myChart,chartData.labels,chartData);
		}
		function initalDemandChanged(event){
			Bdemand = parseInt(event.target.value);
			resetChart();
		}

		function initalSupplyChanged(){
			Bdemand = parseInt(event.target.value);
			resetChart();
		}
		function supplyChangeUpdated(){
			Bdemand = parseInt(event.target.value);
			resetChart();
		}
		function demandChangeUpdated(){
			Bdemand = parseInt(event.target.value);
			resetChart();
		}
		}
	
    </script>
  </body>
</html>